<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESP32-CAM WebRTC Viewer</title>
  </head>
  <body>
    <video id="video" autoplay playsinline controls muted></video>
    <script>
      const ws = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws"
      );

      let pc;
      const iceServers = [{ urls: "stun:stun.l.google.com:19302" }];

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === "offer") {
          pc = new RTCPeerConnection({ iceServers });
          pc.ontrack = (ev) => (document.getElementById("video").srcObject = ev.streams[0]);
          pc.onicecandidate = (e) => {
            if (e.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
          };

          await pc.setRemoteDescription(msg);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify(pc.localDescription));
        } else if (msg.type === "candidate" && pc) {
          try {
            await pc.addIceCandidate(msg.candidate);
          } catch (e) {
            console.warn(e);
          }
        }
      };
    </script>
  </body>
</html>
