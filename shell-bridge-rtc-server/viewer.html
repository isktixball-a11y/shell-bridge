<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>SHELL Live (WS)</title>
  <style>
    html,body{height:100%;margin:0;background:#111;color:#eee;font-family:sans-serif}
    .wrap{display:grid;place-items:center;height:100%}
    canvas{max-width:98vw;max-height:96vh;background:#000;image-rendering:auto}
    .top{position:fixed;top:8px;left:12px;font-size:14px;color:#9ae}
  </style>
</head>
<body>
  <div class="top" id="info">connecting…</div>
  <div class="wrap"><canvas id="c"></canvas></div>
  <script>
    const q = new URLSearchParams(location.search);
    const cameraId = q.get("cameraId") || "DEMO-001";
    const info = document.getElementById("info");
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");

    // render JPEG blobs quickly by swapping an <img> in memory onto canvas
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
      URL.revokeObjectURL(img.src);
    };

    function connect() {
      // auto-upgrade to wss on https sites
      const proto = location.protocol === "https:" ? "wss" : "ws";
      const url = `${proto}://${location.host}/ws/view/${cameraId}`;
      const ws = new WebSocket(url);
      ws.binaryType = "arraybuffer";
      ws.onopen = () => info.textContent = `live: ${cameraId}`;
      ws.onmessage = (ev) => {
        const blob = new Blob([ev.data], { type: "image/jpeg" });
        img.src = URL.createObjectURL(blob);
      };
      ws.onclose = () => {
        info.textContent = "disconnected – retrying…";
        setTimeout(connect, 1500);
      };
      ws.onerror = () => ws.close();
    }
    connect();
  </script>
</body>
</html>
